Screens:
  scrAddEditWorkOrder2: # Consider renaming this screen in your app to something like "scrWorkOrderView"
    Properties:
      Fill: =RGBA(255, 255, 255, 1)
      LoadingSpinnerColor: =RGBA(56, 102, 158, 1) # Color from screenshot
      OnVisible: |-
        =Set(
            varCurrentWO,
            galWorkOrderList.Selected # Assuming navigation from the list screen sets this correctly
        );
        # If varCurrentWO is blank (e.g., direct navigation without selection), redirect or handle
        If(IsBlank(varCurrentWO.WorkOrderID), Navigate(scrWorkOrderList, ScreenTransition.None));
        UpdateContext({ctlSelectedTab: "Details"}); # Default to Details tab

    Children:
      # --- START OF LEFT NAVIGATION PANE (Mimicking screenshot) ---
      - conLeftNavPanel:
          Control: ModernAutoWidthHeightContainer@1.0.0 # Using a modern container
          Properties:
            Fill: =RGBA(240, 243, 246, 1) # Light grey
            Width: =260
            Height: "=Parent.Height"
            LayoutDirection: =LayoutDirection.Vertical
          Children:
            - lblAppName:
                Control: Label@2.5.1
                Properties:
                  Text: ="Acme Co"
                  Font: =Font.'Segoe UI Semibold'
                  Size: =16
                  PaddingLeft: =25
                  PaddingTop: =25
                  Height: =70
            - galNavItems: # Gallery for navigation
                Control: Classic/Gallery@2.3.0
                Properties:
                  Items: =Table(
                    {ID:1, Name:"Dashboard", Icon:Icon.Home, TargetScreen:App.ActiveScreen, IsSelectedSection:false},
                    {ID:2, Name:"Assets", Icon:Icon.Assets, TargetScreen:App.ActiveScreen, IsSelectedSection:false},
                    {ID:3, Name:"Work Orders", Icon:Icon.Wrench, TargetScreen:scrWorkOrderList, IsSelectedSection:true},
                    {ID:4, Name:"Parts", Icon:Icon.Stack, TargetScreen:App.ActiveScreen, IsSelectedSection:false},
                    {ID:5, Name:"Reports", Icon:Icon.ReportDocument, TargetScreen:App.ActiveScreen, IsSelectedSection:false}
                  )Children:
                    - rectNavHighlight:
                        Control: Rectangle@2.3.0
                        Properties:
                          Fill: =If(ThisItem.IsSelectedSection, RGBA(226, 235, 243, 1)) # Highlight fill for selected section
                          Width: =Parent.TemplateWidth - 10
                          Height: =Parent.TemplateHeight - 10 # Add a value for the Height property
                  TemplateSize: =55
                  Width: =Parent.Width
                  Height: =Parent.Height - lblAppName.Height # Fill remaining space
                  OnSelect: =Navigate(Self.Selected.TargetScreen)
                Children:
                  - rectNavHighlight:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: =If(ThisItem.IsSelectedSection, RGBA(226, 235, 243, 1)) # Highlight fill for selected section
                        Width: =Parent.TemplateWidth - 10
                        Height: =Parent.TemplateHeight - 10
                        X: =5
                        Y: =5
                        RadiusTopLeft: =5
                        RadiusBottomLeft: =5
                        RadiusTopRight: =5
                        RadiusBottomRight: =5
                        Visible: =ThisItem.Name = "Work Orders" # Example for "Work Orders" being selected
                  - icoNavItem:
                      Control: Icon@2.3.0
                      Properties:
                        Icon: =ThisItem.Icon
                        X: =25
                        Y: =(Parent.TemplateHeight - Self.Height)/2
                        Width: =22
                        Height: =22
                        Color: =If(ThisItem.Name = "Work Orders", RGBA(56, 102, 158, 1), RGBA(90, 90, 90, 1))
                  - lblNavItemName:
                      Control: Label@2.5.1
                      Properties:
                        Text: =ThisItem.Name
                        X: =icoNavItem.X + icoNavItem.Width + 15
                        Y: =(Parent.TemplateHeight - Self.Height)/2
                        FontWeight: =If(ThisItem.Name = "Work Orders", FontWeight.Semibold, FontWeight.Normal)
                        Color: =If(ThisItem.Name = "Work Orders", RGBA(56, 102, 158, 1), RGBA(90, 90, 90, 1))
                        Size: =12
                        Width: =Parent.TemplateWidth - Self.X - 10
                        AutoHeight: =true
      # --- END OF LEFT NAVIGATION PANE ---

      # --- START OF MAIN CONTENT AREA ---
      - conMainArea:
          Control: ModernAutoWidthHeightContainer@1.0.0
          Properties:
            X: =conLeftNavPanel.Width
            Width: =Parent.Width - conLeftNavPanel.Width
            Height: =Parent.Height
            PaddingLeft: =30
            PaddingRight: =30
            PaddingTop: =25
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =20 # Gap between sections
          Children:
            # Breadcrumbs
            - lblBreadcrumbs:
                Control: Label@2.5.1
                Properties:
                  Text: ="Work Orders / " & varCurrentWO.WorkOrderNumber
                  Size: =11
                  Color: =RGBA(120, 120, 120, 1)
                  Height: =25

            # WO Number Header & Scheduled Date
            - lblWONumberHeader:
                Control: Label@2.5.1
                Properties:
                  Text: =varCurrentWO.WorkOrderNumber
                  Font: =Font.'Segoe UI Semibold'
                  Size: =22
                  Height: =35
            - lblScheduledDateHeader:
                Control: Label@2.5.1
                Properties:
                  Text: ="Scheduled for " & Text(varCurrentWO.ScheduledStartDate, DateTimeFormat.ShortDate) # Or DueDate
                  Size: =11
                  Color: =RGBA(120, 120, 120, 1)
                  Height: =20

            # Tabs (Details, Tasks, Materials)
            - conTabs:
                Control: ModernAutoWidthHeightContainer@1.0.0
                Properties:
                  LayoutDirection: LayoutDirection.Horizontal
                  Height: =45
                  LayoutGap: =5 # Minimal gap
                Children:
                  - btnDetailsTab:
                      Control: Classic/Button@2.2.0
                      Properties:
                        Text: ="Details"
                        OnSelect: "=UpdateContext({ctlSelectedTab: 'Details'})"
                        Fill: =If(ctlSelectedTab="Details", Transparent, RGBA(245, 245, 245, 1))
                        Color: =If(ctlSelectedTab="Details", RGBA(56, 102, 158, 1), RGBA(90, 90, 90, 1))
                        BorderThickness: "=0"
                        BorderBottomThickness: =If(ctlSelectedTab="Details", 2, 0)
                        BorderColor: =RGBA(56, 102, 158, 1)
                        RadiusTopLeft: =4
                        RadiusTopRight: =4
                        Height: =Parent.Height
                        Width: =100
                  - btnTasksTab:
                      Control: Classic/Button@2.2.0
                      Properties:
                        Text: ="Tasks"
                        OnSelect: |-
                          =UpdateContext({ctlSelectedTab: "Tasks"});
                          # Navigate(scrWorkOrderTasks, ScreenTransition.None, {SelectedWorkOrderID: varCurrentWO.WorkOrderID}) # Keep separate navigation if Tasks screen is complex
                        Fill: =If(ctlSelectedTab="Tasks", Transparent, RGBA(245, 245, 245, 1))
                        Color: =If(ctlSelectedTab="Tasks", RGBA(56, 102, 158, 1), RGBA(90, 90, 90, 1))
                        BorderThickness: =0
                        BorderBottomThickness: =If(ctlSelectedTab="Tasks", 2, 0)
                        BorderColor: =RGBA(56, 102, 158, 1)
                        RadiusTopLeft: =4
                        RadiusTopRight: =4
                        Height: =Parent.Height
                        Width: =100
                  - btnMaterialsTab:
                      Control: Classic/Button@2.2.0
                      Properties:
                        Text: ="Materials"
                        OnSelect: "=UpdateContext({ctlSelectedTab: 'Materials'})"
                        Fill: =If(ctlSelectedTab="Materials", Transparent, RGBA(245, 245, 245, 1))
                        Color: "=If(ctlSelectedTab='Materials', RGBA(56, 102, 158, 1), RGBA(90, 90, 90, 1))"
                        BorderThickness: =0
                        BorderBottomThickness: =If(ctlSelectedTab="Materials", 2, 0)
                        BorderColor: =RGBA(56, 102, 158, 1)
                        RadiusTopLeft: =4
                        RadiusTopRight: =4
                        Height: =Parent.Height
                        Width: =100
            - rectTabBottomBorder: # Visual border under tabs
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =RGBA(220, 220, 220, 1)
                  Height: =1
                  Width: =Parent.Width
                  Y: =conTabs.Y + conTabs.Height - Self.Height # Position just below tabs container

            # Container for "Details" Tab Content
            - conDetailsContent:
                Control: ModernAutoWidthHeightContainer@1.0.0 # Scrollable container for details
                Properties:
                  Visible: =ctlSelectedTab = "Details"
                  LayoutDirection: =LayoutDirection.Vertical
                  LayoutMode: "Auto" # Enables scrolling if content overflows
                  LayoutGap: =20
                  PaddingTop: =20
                  Height: =Parent.Height - conHeader.Height - conTabs.Height - rectTabBottomBorder.Height - conActionButtons.Height - 100 # Adjust height dynamically
                Children:
                  - lblWorkOrderDetailsSection:
                      Control: Label@2.5.1
                      Properties:
                        Text: ="Work Order Details"
                        Font: =Font.'Segoe UI Semibold'
                        Size: =14
                        Height: =30
                  - galWODetails:
                      Control: Classic/Gallery@2.3.0
                      Properties:
                        Items: =Table(
                          {Row:1, Label1:"Status", Value1:varCurrentWO.Status, Label2:"Priority", Value2:varCurrentWO.Priority},
                          {Row:2, Label1:"Assigned To", Value1:LookUp(CMMS_Technicians, TechnicianID = varCurrentWO.AssignedTechnicianID).TechnicianName, Label2:"Equipment", Value2:LookUp(CMMS_Equipment, EquipmentID = varCurrentWO.EquipmentID).EquipmentName},
                          {Row:3, Label1:"Location", Value1:Coalesce(varCurrentWO.LocationOverride, LookUp(CMMS_Equipment, EquipmentID = varCurrentWO.EquipmentID).Location), Label2:"Requested By", Value2:varCurrentWO.RequestedBy},
                          {Row:4, Label1:"Description", Value1:varCurrentWO.Description, Label2:"Notes", Value2:varCurrentWO.CompletionNotes}
                        )                        Items: =Table(
                                                  {Row:1, Label1:"Status", Value1:varCurrentWO.Status, Label2:"Priority", Value2:varCurrentWO.Priority},
                                                  {Row:2, Label1:"Assigned To", Value1:LookUp(CMMS_Technicians, TechnicianID = varCurrentWO.AssignedTechnicianID).TechnicianName, Label2:"Equipment", Value2:LookUp(CMMS_Equipment, EquipmentID = varCurrentWO.EquipmentID).EquipmentName},
                                                  {Row:3, Label1:"Location", Value1:Coalesce(varCurrentWO.LocationOverride, LookUp(CMMS_Equipment, EquipmentID = varCurrentWO.EquipmentID).Location), Label2:"Requested By", Value2:varCurrentWO.RequestedBy},
                                                  {Row:4, Label1:"Description", Value1:varCurrentWO.Description, Label2:"Notes", Value2:varCurrentWO.CompletionNotes}
                                                ),
                        TemplateSize: =65
                        Width: =Parent.Width
                        Height: =CountRows(Self.AllItems) * Self.TemplateSize
                        ShowScrollbar: =false
                      Children:
                        - conDetailRowContainer:
                            Control: ModernAutoWidthHeightContainer@1.0.0
                            LayoutDirection: LayoutDirection.Horizontal
                            Properties:
                              Width: =Parent.TemplateWidth
                              Height: =Parent.TemplateHeight
                              LayoutGap: =Parent.TemplateWidth * 0.05
                            Children:
                              - conDetailItemLeft:
                                  Control: ModernAutoWidthHeightContainer@1.0.0
                                  LayoutDirection: LayoutDirection.Vertical
                                  Properties:
                                    Width: =(Parent.Width - Parent.LayoutGap) / 2
                                  Children:
                                    - lblDetailItemLabelLeft:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Label1
                                          Size: =10
                                          Color: =RGBA(120, 120, 120, 1)
                                          Height: =20
                                    - lblDetailItemValueLeft:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Value1
                                          FontWeight: =FontWeight.Semibold
                                          Size: =12
                                          AutoHeight: =true
                                          Wrap: =true
                                          Height: =40
                              - conDetailItemRight:
                                  Control: ModernAutoWidthHeightContainer@1.0.0
                                  LayoutDirection: LayoutDirection.Vertical
                                  Properties:
                                    Width: =(Parent.Width - Parent.LayoutGap) / 2
                                    Visible: =!IsBlank(ThisItem.Label2)
                                  Children:
                                    - lblDetailItemLabelRight:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Label2
                                          Size: =10
                                          Color: =RGBA(120, 120, 120, 1)
                                          Height: =20
                                    - lblDetailItemValueRight:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Value2
                                          FontWeight: =FontWeight.Semibold
                                          Size: =12
                                          AutoHeight: =true
                                          Wrap: =true
                                          Height: =40
                        - sepGalleryRow:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: =RGBA(230, 230, 230, 1)
                              Height: =1
                              Width: =Parent.TemplateWidth
                              Y: =Parent.TemplateHeight - Self.Height

                  - lblTimeTrackingSection:
                      Control: Label@2.5.1
                      Properties:
                        Text: ="Time Tracking"
                        Font: =Font.'Segoe UI Semibold'
                        Size: =14
                        Height: =30
                        PaddingTop: =10 # Space above section
                  # Gallery for Time Tracking
                  - galTimeTracking:
                      Control: Classic/Gallery@2.3.0
                      Properties:
                        Items: =Table( {Row:1, Label1:"Start Time", Value1:Text(varCurrentWO.ActualStartDate, DateTimeFormat.ShortDateTime), Label2:"End Time", Value2:Text(varCurrentWO.ActualEndDate, DateTimeFormat.ShortDateTime)}, {Row:2, Label1:"Total Time", Value1:varCurrentWO.ActualHours & " hours", Label2:"Technician", Value2:LookUp(CMMS_Technicians, TechnicianID = varCurrentWO.AssignedTechnicianID).TechnicianName})
                        TemplateSize: =65
                        Width: =Parent.Width
                        Height: =CountRows(Self.AllItems) * Self.TemplateSize
                        ShowScrollbar: =false
                      Children:
                        - conDetailRowContainer: # Container for a row with two detail items (copied from galWODetails)
                            Control: ModernAutoWidthHeightContainer@1.0.0
                            LayoutDirection: LayoutDirection.Horizontal
                            Properties:
                              Width: =Parent.TemplateWidth
                              Height: =Parent.TemplateHeight
                              LayoutGap: =Parent.TemplateWidth * 0.05 # 5% gap
                            Children:
                              - conDetailItemLeft:
                                  Control: ModernAutoWidthHeightContainer@1.0.0
                                  LayoutDirection: LayoutDirection.Vertical
                                  Properties:
                                    Width: =(Parent.Width - Parent.LayoutGap) / 2 # Approx half width
                                  Children:
                                    - lblDetailItemLabelLeft:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Label1
                                          Size: =10
                                          Color: =RGBA(120, 120, 120, 1)
                                          Height: =20
                                    - lblDetailItemValueLeft:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Value1
                                          FontWeight: =FontWeight.Semibold
                                          Size: =12
                                          AutoHeight: =true # Allows wrap
                                          Wrap: =true
                                          Height: =40
                              - conDetailItemRight:
                                  Control: ModernAutoWidthHeightContainer@1.0.0
                                  LayoutDirection: LayoutDirection.Vertical
                                  Properties:
                                    Width: =(Parent.Width - Parent.LayoutGap) / 2 # Approx half width
                                    Visible: =!IsBlank(ThisItem.Label2)
                                  Children:
                                    - lblDetailItemLabelRight:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Label2
                                          Size: =10
                                          Color: =RGBA(120, 120, 120, 1)
                                          Height: =20
                                    - lblDetailItemValueRight:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: =ThisItem.Value2
                                          FontWeight: =FontWeight.Semibold
                                          Size: =12
                                          AutoHeight: =true
                                          Wrap: =true
                                          Height: =40
                        - sepGalleryRow:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: =RGBA(230, 230, 230, 1)
                              Height: =1
                              Width: =Parent.TemplateWidth
                              Y: =Parent.TemplateHeight - Self.Height

            # Action Buttons Container (Positioned at the bottom of conMainArea)
            - conActionButtons:
                Control: ModernAutoWidthHeightContainer@1.0.0
                LayoutDirection: LayoutDirection.Horizontal
                LayoutJustifyContent: LayoutJustifyContent.End # Aligns button to the right
                Properties:
                  Width: =Parent.Width
                  Height: =60 # Fixed height for button area
                  LayoutAlignItems: LayoutAlignItems.Center # Vertically center button
                  Y: =Parent.Height - Self.Height - Parent.PaddingBottom # Position at bottom
                Children:
                  - btnCompleteWorkOrder:
                      Control: Classic/Button@2.2.0
                      Properties:
                        Text: ="Complete Work Order"
                        Fill: =RGBA(0, 114, 198, 1) # Blue from screenshot
                        Color: =RGBA(255, 255, 255, 1)
                        Height: =40
                        Width: =180
                        RadiusTopLeft: =4
                        RadiusBottomLeft: =4
                        RadiusTopRight: =4
                        RadiusBottomRight: =4
                        Visible: =varCurrentWO.Status <> "Completed"
                        OnSelect: |-
                          =Patch(
                              CMMS_WorkOrders,
                              varCurrentWO,
                              {
                                  Status: "Completed",
                                  ActualEndDate: Now()
                                  # Add fields here if you want to prompt for CompletionNotes, ActualHours etc.
                                  # e.g. CompletionNotes: txtCompletionNotesPopup.Text (if using a popup)
                              }
                          );
                          Notify("Work Order " & varCurrentWO.WorkOrderNumber & " status updated to Completed.", NotificationType.Success);
                          Set(varCurrentWO, LookUp(CMMS_WorkOrders, WorkOrderID = varCurrentWO.WorkOrderID)); # Refresh the local variable

            # Container for "Tasks" Tab Content (placeholder or actual content)
            - conTasksContent:
                Control: ModernAutoWidthHeightContainer@1.0.0
                Properties:
                  Visible: =ctlSelectedTab = "Tasks"
                  # If navigating, this might just be a label. If embedding, put scrWorkOrderTasks content here.
                Children:
                  - lblTasksPlaceholder:
                      Control: Label@2.5.1
                      Properties:
                        Text: ="Tasks details will be shown here. (Consider navigating to scrWorkOrderTasks via the tab button's OnSelect)"
                        Align: =Align.Center
                        VerticalAlign: =VerticalAlign.Middle
                        Height: =Parent.Height

            # Container for "Materials" Tab Content (placeholder)
            - conMaterialsContent:
                Control: ModernAutoWidthHeightContainer@1.0.0
                Properties:
                  Visible: =ctlSelectedTab = "Materials"
                Children:
                  - lblMaterialsPlaceholder:
                      Control: Label@2.5.1
                      Properties:
                        Text: ="Materials used on this work order will be shown here."
                        Align: =Align.Center
                        VerticalAlign: =VerticalAlign.Middle
                        Height: =Parent.Height